# Transactions

**Транзакция** — это последовательность операций с базой данных, которая выполняется как единое логическое действие. Транзакции обеспечивают целостность данных даже в случае сбоев или ошибок. Пример: обновление баланса на счетах после перевода.

Транзакция может состоять из нескольких операций, но рассматривается как единое целое. Если одна из операций не может быть выполнена, все изменения, внесенные транзакцией, отменяются.

## Свойства ACID

Транзакции в реляционных базах данных придерживаются набора свойств, известных как **ACID**. Эти свойства обеспечивают надежность и согласованность данных.

### Atomicity (атомарность)

Гарантирует, что транзакция выполняется полностью или не выполняется вовсе.
Если происходит сбой, все изменения, сделанные в рамках транзакции, откатываются.
Пример: при переводе денег между счетами, списание со счета A и зачисление на счет B выполняются как единое целое. Если зачисление на счет B невозможно, списание с A будет отменено.

### Consistency (согласованность)

Данные переходят из одного согласованного состояния в другое. Это значит, что в ходе транзакции база данных не нарушает своих правил (например, ограничений целостности).
**Пример**: в банковской системе сумма на счетах должна сохраняться после перевода.

### Isolation (изоляция)

Транзакции не должны мешать друг другу. Результаты выполнения одной транзакции не видны другим до тех пор, пока она не завершена.
Существует несколько уровней изоляции (например, Read Uncommitted, Read Committed, Repeatable Read, Serializable), которые регулируют, как транзакции взаимодействуют друг с другом.
**Пример**: пока одна транзакция выполняет перевод средств, другая не может увидеть промежуточное состояние счета.

### Durability (долговечность)

После подтверждения транзакции изменения сохраняются в базе данных и не теряются даже в случае сбоя системы.
**Пример**: если база данных подтверждает успешный перевод, данные будут сохранены на диске или в журнале транзакций.

## Жизненный цикл транзакции

* **Начало**: транзакция открывается.
* **Операции**: выполняются изменения данных (вставка, обновление, удаление).
* **Подтверждение (COMMIT)**: все изменения подтверждаются и становятся постоянными.
* **Откат (ROLLBACK)**: если возникает ошибка или сбой, все изменения отменяются.

## Уровни изоляции

Уровни изоляции определяют, как транзакции могут взаимодействовать друг с другом. Это важно для предотвращения конфликтов и ошибок, таких как:

* **Dirty Read**: транзакция читает данные, которые еще не подтверждены другой транзакцией.
* **Non-repeatable Read**: при повторном чтении данных в рамках одной транзакции результат отличается, так как другая транзакция изменила эти данные.
* **Phantom Read**: при повторном запросе появляется новый набор строк из-за изменений, внесенных другой транзакцией.

### Основные уровни изоляции

* **Read Uncommitted**: самая низкая изоляция, позволяет dirty reads.
* **Read Committed**: запрещает dirty reads, но возможны non-repeatable reads.
* **Repeatable Read**: запрещает dirty reads и non-repeatable reads, но возможны phantom reads.
* **Serializable**: самая высокая изоляция, предотвращает все перечисленные проблемы, но снижает производительность.

## Примеры транзакций

* Пример успешной транзакции:

```SQL
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
UPDATE accounts SET balance = balance + 100 WHERE account_id = 2;
COMMIT;
```

* Пример транзакции с откатом:

```SQL
BEGIN TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE account_id = 1;
-- Ошибка, например, недостаточно средств на счету
ROLLBACK;
```
